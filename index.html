<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>yin xue</title>
<script src="https://dennisdebel.nl/2017/jquery.min.js"></script>

<script>
$(function(){
  let manifest = null;

  // Create persistent header first
  createHeader();

  // Load manifest once
  $.getJSON("manifest.json", function(data){
      manifest = data;
      const params = new URLSearchParams(window.location.search);
      const section = params.get("section");
      const project = params.get("project");

      if(section && project && data[section] && data[section][project]){
          loadProject(section, project, false);
      } else {
          buildHome(data);
      }
  }).fail(function(){
      $("body").append("<p style='color:red'>manifest.json not found</p>");
  });

  // -------------------- Header --------------------
  function createHeader(){
    if(!$("#global-header").length){
        $("body").prepend(`
          <div id="global-header">
            <span id='name'><a href='#' id='show-all'>yin xue</a></span>
            <span id='menu'>
              <a href='#' id='show-projects'>projects</a>&nbsp;&nbsp;
              <a href='#' id='show-commissions'>commissions</a>&nbsp;&nbsp;
              <a href='#' id='show-about'>about</a>
            </span>
          </div>
        `);
    }

    // Remove old handlers and attach fresh ones each time
    $(document)
      .off("click.section")
      .on("click.section", "#show-all", (e)=>{ e.preventDefault(); showSection("all"); })
      .on("click.section", "#show-projects", (e)=>{ e.preventDefault(); showSection("projects"); })
      .on("click.section", "#show-commissions", (e)=>{ e.preventDefault(); showSection("commissions"); })
      .on("click.section", "#show-about", (e)=>{ e.preventDefault(); showSection("about"); });
  }

  // -------------------- Build Grid --------------------
  function buildHome(data){
      const oldContent = $(".content");
      if(oldContent.length){
          oldContent.fadeOut(200, ()=>{ oldContent.remove(); renderGrid(data); });
      } else {
          renderGrid(data);
      }
  }

  function renderGrid(data){
      $("body").append("<div class='content grid' style='display:none'></div>");
      const grid = $(".grid");

      for (const section in data){
          const folders = data[section];
          for (const folder in folders){
              const files = folders[folder];
              const img = files.find(f => /\.(png|jpe?g|gif)$/i.test(f));
              const txt = files.find(f => /\.txt$/i.test(f));

              if(section === "about"){
                  grid.append(`
                    <div class='grid-item about-item'>
                      <div class='about-text' data-file='${section}/${txt || ""}'>Loading…</div>
                    </div>
                  `);
              } else if(img){
                  grid.append(`
                    <div class='grid-item ${section}-item' data-section='${section}' data-folder='${folder}'>
                      <a href='?section=${section}&project=${folder}' class='open-project'>
                        <img src='${section}/${img}' alt='${folder}' />
                      </a>
                      ${txt ? `<p class='desc'>${folder}</p>` : ""}
                    </div>
                  `);
              }
          }
      }

      // Load about text
      $("[data-file]").each(function(){
          const el = $(this);
          const file = el.data("file");
          if(file && file.endsWith(".txt")){
              $.get(file, t=>el.text(t));
          }
      });

      // Click project thumbnail
      $(".open-project").on("click", function(e){
          e.preventDefault();
          const parent = $(this).closest(".grid-item");
          loadProject(parent.data("section"), parent.data("folder"), true);
      });

      addFooter(grid);
      grid.fadeIn(400);
  }

  // -------------------- Section Filter --------------------
  function showSection(section){
    const grid = $(".grid");
    if(!grid.length) return;

    const allItems = $(".grid-item");
    const projItems = $(".projects-item");
    const commItems = $(".commissions-item");
    const aboutItems = $(".about-item");

    // Clear active link highlight
    $("#menu a").removeClass("active");

    // Reset all to hidden first (instant collapse)
    allItems.stop(true,true)
      .css({
        "opacity": 0,
        "pointer-events": "none",
        "display": "none"
      });

    // Helper: show a specific set nicely
    function reveal($el) {
      $el.css({
        "display": "flex",
        "opacity": 0
      }).animate({opacity:1}, 300)
       .css({
         "pointer-events":"auto",
         "flex":"1 0 40%"
       });
    }

    switch(section){
      case "projects":
        $("#show-projects").addClass("active");
        reveal(projItems);
        break;

      case "commissions":
        $("#show-commissions").addClass("active");
        reveal(commItems);
        break;

      case "about":
        $("#show-about").addClass("active");
        reveal(aboutItems);
        break;

      case "all":
      default:
        $("#show-all").addClass("active");
        reveal(allItems);
        break;
    }

    // Optional: auto-scroll to top for better mobile UX
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // -------------------- Project View --------------------
  function loadProject(section, folder, push){
      const oldContent = $(".content");
      oldContent.fadeOut(200, ()=>{ oldContent.remove(); renderProject(section, folder, push); });
  }

  function renderProject(section, folder, push){
      $("body").append("<div class='content project-view' style='display:none'></div>");
      const view = $(".project-view");
      const files = manifest[section][folder];

      if(push){
          const newUrl = `?section=${encodeURIComponent(section)}&project=${encodeURIComponent(folder)}`;
          history.pushState({section, folder}, "", newUrl);
      }

      if(!$(".project-back").length){
          $("#global-header").after(`<div class='project-back'><a href='#' id='back-home'>← back</a></div>`);
      }

      $("#back-home").off().on("click", function(e){
          e.preventDefault();
          history.pushState({}, "", "./");
          $(".project-back").fadeOut(200, ()=>$(this).remove());
          buildHome(manifest);
      });

      for(const f of files){
          if(/\.(png|jpe?g|gif)$/i.test(f)){
              view.append(`<div class='project-image'><img src='${section}/${f}' alt='${folder}' /></div>`);
          }
      }
      for(const f of files){
          if(/\.txt$/i.test(f)){
              view.append(`<div class='project-text' data-file='${section}/${f}'>Loading…</div>`);
          }
      }

      $(".project-text").each(function(){
          const el = $(this);
          $.get(el.data("file"), t=>el.text(t));
      });

      addFooter(view);
      view.fadeIn(400);
  }

  // -------------------- Browser History --------------------
  window.onpopstate = function(event){
      if(event.state && event.state.section && event.state.folder){
          loadProject(event.state.section, event.state.folder, false);
      } else {
          buildHome(manifest);
      }
  };

  // -------------------- Footer --------------------
  function addFooter(target){
      target.append(`
        <div class='footer'>
          <div class='row'>
            <div class='column'>
            </div>
            <div class='column'>
            </div>
            <div class='column'>
            </div>
            <div class='column'></div>
          </div>
        </div>
      `);
  }

});
</script>

<style>
@font-face {
  font-family:'yolo';
  src:url('https://dennisdebel.nl/2017/NimbusSanL-Reg.woff2') format('woff2'),
      url('https://dennisdebel.nl/2017/NimbusSanL-Reg.ttf') format('truetype');
}
body{font-family:"yolo";margin:0;padding:0;background:#fff;}
a{color:black;text-decoration:none}
pre,address{display:none}

#global-header{
  position:sticky;
  top:0;
  background:white;
  z-index:999;
  padding:1rem 2rem;
}
#menu a{cursor:pointer}
#menu a:hover{text-decoration:underline}
span#name{float:left;font-size:1.3rem}
span#menu{float:right;font-size:1.3rem}

.back-btn,.project-back{
  padding:0.5em 2rem;
  font-size:1rem;
}

.grid{padding:8%;display:flex;flex-wrap:wrap;justify-content:flex-start;align-content:flex-start;}
.grid-item{flex:1 0 40%;padding:1rem;box-sizing:border-box;transition:opacity .3s}
img{width:100%;object-fit:cover;display:block;border-radius:4px;transition:transform .3s ease}
img:hover{transform:scale(1.02)}

.project-view img{width:100%;max-width:800px;margin:auto;display:block;padding-bottom:1rem;opacity:0;animation:fadeIn .5s forwards;}
@keyframes fadeIn {to{opacity:1;}}

.project-text,.about-text{
  max-width:600px;line-height:1.5em;font-size:14px;
  padding:1em;margin:auto;opacity:0;animation:fadeIn .8s forwards;
}

.footer{padding-top:50px;padding-left:20px;width:96.5%;padding-bottom:3rem;opacity:0;animation:fadeIn 1s forwards;}
.column{float:left;width:25%}
.row:after{content:"";display:table;clear:both}

@media (max-width:800px){
  .grid{flex-direction:column;padding:1rem;}
  .grid-item{padding:0}
  img{width:100%}
  .column{width:100%}
  #global-header{padding:1rem}
}
</style>
</head>
<body></body>
</html>
