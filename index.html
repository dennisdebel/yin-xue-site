<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>yin xue</title>
<script src="./jquery.min.js"></script>

<script>
$(function(){
  let manifest = null;

  // ---------- Boot ----------
  createHeader();

  // Prepare wrapper containers (once)
  if (!$("#site-wrapper").length) {
    $("body").append(`
      <main id="site-wrapper"></main>
      <footer id="global-footer"></footer>
    `);
  }

  // Load manifest and initialize routing
  $.getJSON("manifest.json")
    .done(data => {
      manifest = data;
      routeFromURL();
      window.addEventListener("popstate", routeFromURL);
    })
    .fail(() => {
      $("#site-wrapper").html("<p style='color:red'>manifest.json not found</p>");
    });

  // ---------- Router ----------
  function routeFromURL() {
    const params = new URLSearchParams(location.search);
    const section = params.get("section");
    const project = params.get("project");

    $(".content, .project-back, .back-btn").remove();

    if (section && project && manifest[section] && manifest[section][project]) {
      renderProject(section, project, false);
    } else {
      renderHome();
    }
  }

  function navigateTo(section, project) {
    const qs = (section && project)
      ? `?section=${encodeURIComponent(section)}&project=${encodeURIComponent(project)}`
      : `./`;
    history.pushState({ section, project }, "", qs);
    routeFromURL();
  }

  // ---------- Header ----------
  function createHeader(){
    $("#global-header").html(`
      <span id='name'><a href='#' id='show-all'>yin xue</a></span>
      <span id='menu'>
        <a href='#' id='show-projects'>projects</a>&nbsp;&nbsp;
        <a href='#' id='show-commissions'>commissions</a>&nbsp;&nbsp;
        <a href='#' id='show-about'>about</a>
      </span>
    `);

    $(document)
      .off("click.nav")
      .on("click.nav", "#show-all", e => { e.preventDefault(); goHomeAndFilter("all"); })
      .on("click.nav", "#show-projects", e => { e.preventDefault(); goHomeAndFilter("projects"); })
      .on("click.nav", "#show-commissions", e => { e.preventDefault(); goHomeAndFilter("commissions"); })
      // ✅ this is the corrected line (removed stray paren)
      .on("click.nav", "#show-about", e => {
        e.preventDefault();
        $(".content, .project-back, .back-btn").remove();
        renderAbout();
      });
  }


  // ---------- Go Home + Filter ----------
  function goHomeAndFilter(section){
    $(".content, .project-back, .back-btn").remove();
    history.pushState({}, "", "./");

    if (manifest){
      renderHome();
      setTimeout(()=>showSection(section), 200);
    } else {
      $.getJSON("manifest.json").done(data=>{
        manifest = data;
        renderHome();
        setTimeout(()=>showSection(section), 200);
      });
    }
  }

  // ---------- Home (Grid) ----------
  function renderHome(){
    $("#site-wrapper").html("<div class='content grid' style='display:none'></div>");
    const $grid = $("#site-wrapper .grid");

    for (const section in manifest){
      // ✅ Skip about section entirely when building the homepage grid
      if (section === "about") continue;

      const folders = manifest[section];
      for (const folder in folders){
        const files = folders[folder];
        const img = files.find(f => /featured\.(jpe?g)$/i.test(f));
        const txt = files.find(f => /\.txt$/i.test(f));
        const hasFeatured = Boolean(img);

        if (hasFeatured) {
          $grid.append(`
            <div class='grid-item ${section}-item' data-section='${section}' data-folder='${folder}'>
              <a href='?section=${encodeURIComponent(section)}&project=${encodeURIComponent(folder)}' class='open-project'>
                <img src='${section}/${img}' alt='${folder}'/>
              </a>
              ${txt ? `<p class='desc'>${folder}</p>` : ""}
            </div>
          `);
        }
      }
    }


    // Load about text
    $grid.find("[data-file]").each(function(){
      const el = $(this);
      const file = el.data("file");
      if(file && file.endsWith(".txt")){
        $.get(file, t => el.text(t));
      }
    });

    // Click thumbnail
    $grid.on("click", ".open-project", function(e){
      e.preventDefault();
      const parent = $(this).closest(".grid-item");
      navigateTo(parent.data("section"), parent.data("folder"));
    });

    $grid.fadeIn(300);
  }

  // ---------- Section Filter ----------
  function showSection(section){
    const $grid = $(".grid");
    if(!$grid.length) { renderHome(); }

    // when switching to projects or commissions, ensure all folders are visible (not only featured)
    if(section === "projects" || section === "commissions"){
      // rebuild grid showing all thumbnails for this category
      rebuildSection(section);
      return;
    }


    const $all  = $grid.find(".grid-item");
    const $proj = $grid.find(".projects-item");
    const $comm = $grid.find(".commissions-item");
    const $about= $grid.find(".about-item");

    $("#menu a").removeClass("active");
    $all.stop(true,true).css({ display:"none", opacity:0, pointerEvents:"none" });

    const reveal = $el => $el.css({
      display:"flex", opacity:0, pointerEvents:"auto", flex:"0 1 clamp(260px, 40vw, 520px)"
    }).animate({opacity:1}, 250);

    switch(section){
      case "projects": $("#show-projects").addClass("active"); reveal($proj); break;
      case "commissions": $("#show-commissions").addClass("active"); reveal($comm); break;
      case "about": $("#show-about").addClass("active"); reveal($about); break;
      default: $("#show-all").addClass("active"); reveal($all); break;
    }

    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ---------- About View ----------
  function renderAbout(){
    $("#site-wrapper").html("<div class='content about-view' style='display:none'></div>");
    const $view = $("#site-wrapper .about-view");

    const aboutFiles = manifest.about["."] || [];
    const txt = aboutFiles.find(f => /\.txt$/i.test(f));
    const img = aboutFiles.find(f => /\.(png|jpe?g|gif)$/i.test(f));

    if (img) {
      $view.append(`<div class='about-image'><img src='about/${img}' alt='about image'/></div>`);
    }
    if (txt) {
      $view.append(`<div class='about-text' data-file='about/${txt}'>Loading…</div>`);
    }

    // Load the actual text (and render as HTML if needed)
    $view.find(".about-text").each(function(){
      const el = $(this);
      const file = el.data("file");
      $.get(file, t => {
        if (/\<[^>]+\>/.test(t)) el.html(t); // render HTML if tags are present
        else el.text(t);
      });
    });

    $view.fadeIn(300);
  }


  function rebuildSection(section){
    $("#site-wrapper").html("<div class='content grid' style='display:none'></div>");
    const $grid = $("#site-wrapper .grid");

    const folders = manifest[section];
    for (const folder in folders){
      const files = folders[folder];
      const img = files.find(f => /\.(png|jpe?g|gif)$/i.test(f));
      const txt = files.find(f => /\.txt$/i.test(f));
      if(!img) continue;

      $grid.append(`
        <div class='grid-item ${section}-item' data-section='${section}' data-folder='${folder}'>
          <a href='?section=${encodeURIComponent(section)}&project=${encodeURIComponent(folder)}' class='open-project'>
            <img src='${section}/${img}' alt='${folder}'/>
          </a>
          ${txt ? `<p class='desc'>${folder}</p>` : ""}
        </div>
      `);
    }

    $grid.fadeIn(300);
  }

  // ---------- Project View ----------
  function renderProject(section, folder, pushState){
    const files = (manifest && manifest[section]) ? manifest[section][folder] : null;
    if(!files){ renderHome(); return; }

    if (pushState) { navigateTo(section, folder); return; }

    $("#site-wrapper").html("<div class='content project-view' style='display:none'></div>");
    const $view = $("#site-wrapper .project-view");

    // Back button
    if (!$(".project-back").length) {
      $("#global-header").after(`<div class='project-back'><a href='#' id='back-home'>← back</a></div>`);
      $("#back-home").off("click").on("click", function(e){
        e.preventDefault();
        history.pushState({}, "", "./");
        $(".project-back").remove();
        routeFromURL();
      });
    }

    for(const f of files){
      if(/\.(png|jpe?g|gif)$/i.test(f)){
        $view.append(`<div class='project-image'><img src='${section}/${f}' alt='${folder}' /></div>`);
      }
    }

    for(const f of files){
      if(/\.txt$/i.test(f)){
        $view.append(`<div class='project-text' data-file='${section}/${f}'>Loading…</div>`);
      }
    }

    $view.find(".project-text").each(function(){
      const el = $(this);
      $.get(el.data("file"), t => el.text(t));
    });

    $view.fadeIn(300);
  }

});
</script>

<style>
@font-face {
  font-family:'yolo';
  src:url('https://dennisdebel.nl/2017/NimbusSanL-Reg.woff2') format('woff2'),
      url('https://dennisdebel.nl/2017/NimbusSanL-Reg.ttf') format('truetype');
}

body{font-family:"yolo";margin:0;padding:0;background:#fff;}
a{color:black;text-decoration:none}
pre,address{display:none}

/* ---------- Header ---------- */
#global-header{
  position:sticky;
  top:0;
  background:white;
  z-index:999;
  padding:1rem 2rem;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
#menu a{cursor:pointer}
#menu a:hover{text-decoration:underline}
#menu a.active{text-decoration:underline;font-weight:bold}
span#name{font-size:1.3rem}
span#menu{font-size:1.3rem}

/* ---------- Layout ---------- */
#site-wrapper{
  display:flex;
  justify-content:center;
  width:100%;
  min-height:80vh;
  box-sizing:border-box;
}

/* Centered grid */
.content.grid{
  max-width:1200px;
  width:100%;
  margin:0 auto;
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  align-content:flex-start;
  gap:1.25rem;
  padding:2rem 1rem;
  box-sizing:border-box;
}

/* Grid items */
.grid-item{
  display:flex;
  flex-direction:column;
  align-items:center;
  flex:0 1 clamp(260px, 40vw, 520px);
  box-sizing:border-box;
}
.grid-item .desc{
  margin-top:0.5rem;
  text-align:center;
  font-size:0.9rem;
  line-height:1.2;
}
.grid-item img{
  width:100%;
  object-fit:cover;
  border-radius:4px;
  transition:transform .3s ease;
}
.grid-item img:hover{transform:scale(1.02)}

/* Project view */
.project-view img{
  width:100%;
  max-width:800px;
  margin:auto;
  display:block;
  padding-bottom:1rem;
  opacity:0;
  animation:fadeIn .5s forwards;
}
@keyframes fadeIn{to{opacity:1;}}

.project-text,.about-text{
  max-width:600px;
  line-height:1.5em;
  font-size:14px;
  padding:1em;
  margin:auto;
  opacity:0;
  animation:fadeIn .8s forwards;
}

/* Footer (empty container now) */
#global-footer{
  width:100%;
  padding:2rem;
  background:white;
  box-sizing:border-box;
}
/* About view */
.about-image img{
  max-width: 400px;
}

/* Mobile */
@media (max-width:800px){
  .content.grid{
    padding:1rem;
    gap:0.75rem;
  }
  .grid-item{
    flex:0 1 100%;
    max-width:36rem;
  }
  #global-header{padding:1rem}
}
</style>
</head>

<body>
  <div id="global-header"></div>
  <main id="site-wrapper"></main>
  <footer id="global-footer"></footer>
</body>
</html>
