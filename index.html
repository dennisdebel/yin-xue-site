<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
<title>yin xue</title>
<script src="https://dennisdebel.nl/2017/jquery.min.js"></script>

<script>
$(function(){
  let manifest = null;

  // ---------- Boot ----------
  createHeader();

  // Load manifest, then route based on URL (supports deep links)
  $.getJSON("manifest.json")
    .done(data => {
      manifest = data;
      routeFromURL();                    // initial render (supports shared URLs)
      window.addEventListener("popstate", routeFromURL);  // back/forward
    })
    .fail(() => {
      $("body").append("<p style='color:red'>manifest.json not found</p>");
    });

  // ---------- Router ----------
  function routeFromURL() {
    const params = new URLSearchParams(location.search);
    const rawSection = params.get("section");
    const rawProject = params.get("project");

    const section = rawSection ? decodeURIComponent(rawSection) : null;
    const project = rawProject ? decodeURIComponent(rawProject) : null;

    // Clean previous view
    $(".content, .project-back, .back-btn").remove();

    if (section && project && manifest[section] && manifest[section][project]) {
      renderProject(section, project, /*push=*/false);
    } else {
      renderHome(); // default / invalid -> home
    }
  }

  function navigateTo(section, project) {
    const qs = (section && project)
      ? `?section=${encodeURIComponent(section)}&project=${encodeURIComponent(project)}`
      : `./`;
    history.pushState({ section, project }, "", qs);
    routeFromURL();
  }

  // ---------- Header ----------
  function createHeader(){
    if(!$("#global-header").length){
      $("body").prepend(`
        <div id="global-header">
          <span id='name'><a href='#' id='show-all'>yin xue</a></span>
          <span id='menu'>
            <a href='#' id='show-projects'>projects</a>&nbsp;&nbsp;
            <a href='#' id='show-commissions'>commissions</a>&nbsp;&nbsp;
            <a href='#' id='show-about'>about</a>
          </span>
        </div>
      `);
    }

    // Rebind cleanly (namespaced)
    $(document)
      .off("click.nav")
      .on("click.nav", "#show-all",        e => { e.preventDefault(); showSection("all"); })
      .on("click.nav", "#show-projects",   e => { e.preventDefault(); showSection("projects"); })
      .on("click.nav", "#show-commissions",e => { e.preventDefault(); showSection("commissions"); })
      .on("click.nav", "#show-about",      e => { e.preventDefault(); showSection("about"); });
  }

  // ---------- Home (Grid) ----------
  function renderHome(){
    const $grid = $(`<div class='content grid' style='display:none'></div>`);
    $("body").append($grid);

    // Build from manifest
    for (const section in manifest){
      const folders = manifest[section];
      for (const folder in folders){
        const files = folders[folder];
        const img = files.find(f => /\.(png|jpe?g|gif)$/i.test(f));
        const txt = files.find(f => /\.txt$/i.test(f));

        if(section === "about"){
          $grid.append(`
            <div class='grid-item about-item'>
              <div class='about-text' data-file='${section}/${txt || ""}'>Loading…</div>
            </div>
          `);
        } else if(img){
          $grid.append(`
            <div class='grid-item ${section}-item' data-section='${section}' data-folder='${folder}'>
              <a href='?section=${encodeURIComponent(section)}&project=${encodeURIComponent(folder)}' class='open-project'>
                <img src='${section}/${img}' alt='${folder}'/>
              </a>
              ${txt ? `<p class='desc'>${folder}</p>` : ""}
            </div>
          `);
        }
      }
    }

    // Load about text (if any)
    $grid.find("[data-file]").each(function(){
      const el = $(this);
      const file = el.data("file");
      if(file && file.endsWith(".txt")){
        $.get(file, t => el.text(t));
      }
    });

    // Thumbnail -> Project
    $grid.on("click", ".open-project", function(e){
      e.preventDefault();
      const $parent = $(this).closest(".grid-item");
      const section = $parent.data("section");
      const folder  = $parent.data("folder");
      navigateTo(section, folder);
    });

    addFooter($grid);
    $grid.fadeIn(300);
  }

  // ---------- Section Filter (no ghost space on mobile) ----------
  function showSection(section){
    const $grid = $(".grid");
    if(!$grid.length) { renderHome(); return; }

    const $all  = $grid.find(".grid-item");
    const $proj = $grid.find(".projects-item");
    const $comm = $grid.find(".commissions-item");
    const $about= $grid.find(".about-item");

    $("#menu a").removeClass("active");

    // Collapse everything first (no space taken)
    $all.stop(true,true).css({ display:"none", opacity:0, pointerEvents:"none" });

    function reveal($el){
      $el.css({ display:"flex", opacity:0, pointerEvents:"auto", flex:"1 0 40%" })
         .animate({opacity:1}, 250);
    }

    switch(section){
      case "projects":
        $("#show-projects").addClass("active");
        reveal($proj);
        break;
      case "commissions":
        $("#show-commissions").addClass("active");
        reveal($comm);
        break;
      case "about":
        $("#show-about").addClass("active");
        reveal($about);
        break;
      case "all":
      default:
        $("#show-all").addClass("active");
        reveal($all);
        break;
    }

    // UX: scroll to top on mobile when switching categories
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  // ---------- Project View ----------
  function renderProject(section, folder, pushState){
    const files = (manifest && manifest[section]) ? manifest[section][folder] : null;
    if(!files){ renderHome(); return; }

    if (pushState) {
      navigateTo(section, folder);
      return; // navigateTo will call routeFromURL -> renderProject again
    }

    const $view = $(`<div class='content project-view' style='display:none'></div>`);
    $("body").append($view);

    // Back (consistent)
    if (!$(".project-back").length) {
      $("#global-header").after(`<div class='project-back'><a href='#' id='back-home'>← back</a></div>`);
      $("#back-home").off("click").on("click", function(e){
        e.preventDefault();
        history.pushState({}, "", "./");
        $(".project-back").remove();   // always remove container
        routeFromURL();                // go home
      });
    }

    // Images
    for(const f of files){
      if(/\.(png|jpe?g|gif)$/i.test(f)){
        $view.append(`<div class='project-image'><img src='${section}/${f}' alt='${folder}' /></div>`);
      }
    }
    // Text (after images)
    for(const f of files){
      if(/\.txt$/i.test(f)){
        $view.append(`<div class='project-text' data-file='${section}/${f}'>Loading…</div>`);
      }
    }
    $view.find(".project-text").each(function(){
      const el = $(this);
      $.get(el.data("file"), t => el.text(t));
    });

    addFooter($view);
    $view.fadeIn(300);
  }

  // ---------- Footer ----------
  function addFooter(target){
    target.append(`
      <div class='footer'>
       
      </div>
    `);
  }

});

</script>

<style>
@font-face {
  font-family:'yolo';
  src:url('https://dennisdebel.nl/2017/NimbusSanL-Reg.woff2') format('woff2'),
      url('https://dennisdebel.nl/2017/NimbusSanL-Reg.ttf') format('truetype');
}
body{font-family:"yolo";margin:0;padding:0;background:#fff;}
a{color:black;text-decoration:none}
pre,address{display:none}

#global-header{
  position:sticky;
  top:0;
  background:white;
  z-index:999;
  padding:1rem 2rem;
}
#menu a{cursor:pointer}
#menu a:hover{text-decoration:underline}
span#name{float:left;font-size:1.3rem}
span#menu{float:right;font-size:1.3rem}

.back-btn,.project-back{
  padding:0.5em 2rem;
  font-size:1rem;
}

.grid{padding:8%;display:flex;flex-wrap:wrap;justify-content:flex-start;align-content:flex-start;}
.grid-item{flex:1 0 40%;padding:1rem;box-sizing:border-box;transition:opacity .3s}
img{width:100%;object-fit:cover;display:block;border-radius:4px;transition:transform .3s ease}
img:hover{transform:scale(1.02)}

.project-view img{width:100%;max-width:800px;margin:auto;display:block;padding-bottom:1rem;opacity:0;animation:fadeIn .5s forwards;}
@keyframes fadeIn {to{opacity:1;}}

.project-text,.about-text{
  max-width:600px;line-height:1.5em;font-size:14px;
  padding:1em;margin:auto;opacity:0;animation:fadeIn .8s forwards;
}

.footer{padding-top:50px;padding-left:20px;width:96.5%;padding-bottom:3rem;opacity:0;animation:fadeIn 1s forwards;}
.column{float:left;width:25%}
.row:after{content:"";display:table;clear:both}

@media (max-width:800px){
  .grid{flex-direction:column;padding:1rem;}
  .grid-item{padding:0}
  img{width:100%}
  .column{width:100%}
  #global-header{padding:1rem}
}
</style>
</head>
<body></body>
</html>
